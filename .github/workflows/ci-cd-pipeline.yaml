name: CI/CD Pipeline for Web Calculator

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  # 关键修复 1: 明确指定组织下的完整镜像路径
  REGISTRY: ghcr.io
  # 使用 github.repository_owner 确保始终指向组织 wkk08
  IMAGE_NAME: ${{ github.repository_owner }}/web-calculator-ci-cd

jobs:
  # 1. 单元测试阶段
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run unit tests
        run: |
          if [ -d tests/unit ]; then
            python -m pytest tests/unit/ -v --cov=app --cov-report=xml
          else
            echo "没有找到单元测试目录"
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: |
            coverage.xml
          retention-days: 7

  # 2. 功能测试阶段
  functional-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build test image
        run: docker build -t web-calculator-test:${{ github.sha }} .

      - name: Run functional tests
        run: |
          # 启动容器
          docker run -d -p 5000:5000 --name web-calc-test web-calculator-test:${{ github.sha }}
          
          # 等待服务启动
          sleep 10
          
          # 运行功能测试（如果存在）
          if [ -f tests/func/run_curl_tests.sh ]; then
            chmod +x tests/func/run_curl_tests.sh
            ./tests/func/run_curl_tests.sh || true
          fi
          
          # 清理
          docker stop web-calc-test || true
          docker rm web-calc-test || true

  # 3. 构建和推送 Docker 镜像（已修复关键问题）
  build-and-push:
    runs-on: ubuntu-latest
    needs: [unit-tests, functional-tests]
    
    # 关键修复 2：授予 GITHUB_TOKEN 推送包的必要权限
    permissions:
      contents: read
      packages: write
    
    # 只在推送到 main/master 分支时运行
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 关键修复 3：清理可能干扰的旧登录信息，并使用正确的凭据登录
      - name: Logout from GHCR to clear cache
        run: docker logout ghcr.io || true

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          # 关键修复 4：用户名使用仓库所有者 (wkk08)，而非触发者
          username: ${{ github.repository_owner }}
          # 关键修复 5：使用GITHUB_TOKEN，而非泄露的PAT
          password: ${{ secrets.GITHUB_TOKEN }}

      # 关键修复 6：确保元数据 Action 生成的镜像名指向 wkk08 组织
      - name: Extract metadata for tags
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate deployment info
        run: |
          echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_ENV
          echo "IMAGE_FULL_NAME=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_ENV

      - name: Create deployment info file
        run: |
          echo "Build completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" > build-info.txt
          echo "Commit SHA: ${{ github.sha }}" >> build-info.txt
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> build-info.txt

      - name: Upload build info
        uses: actions/upload-artifact@v4
        with:
          name: build-info
          path: build-info.txt
          retention-days: 30

  # 4. 部署到红帽服务器
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DEPLOY_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Copy deployment files
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '.github' \
            deploy/ \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER_IP }}:${{ secrets.DEPLOY_DIR }}/

      - name: Execute deployment
        run: |
          ssh -o StrictHostKeyChecking=no \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER_IP }} "
            cd ${{ secrets.DEPLOY_DIR }}
            export IMAGE_TAG=\"${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}\"
            if [ -f current_color ]; then
              CURRENT_COLOR=\$(cat current_color)
            else
              CURRENT_COLOR=\"blue\"
            fi
            if [ \"\$CURRENT_COLOR\" = \"blue\" ]; then
              NEW_COLOR=\"green\"
            else
              NEW_COLOR=\"blue\"
            fi
            echo \"开始蓝绿部署...\"
            echo \"新镜像: \$IMAGE_TAG\"
            echo \"新颜色: \$NEW_COLOR\"
            # 更新环境变量文件
            if [ \"\$NEW_COLOR\" = \"blue\" ]; then
              sed -i \"s|BLUE_TAG=.*|BLUE_TAG=\$IMAGE_TAG|\" .env
            else
              sed -i \"s|GREEN_TAG=.*|GREEN_TAG=\$IMAGE_TAG|\" .env
            fi
            # 执行部署脚本
            ./scripts/deploy \"\$IMAGE_TAG\" \"\$NEW_COLOR\"
            sleep 20
            if ./scripts/health_check; then
              ./scripts/switch_traffic \"\$NEW_COLOR\"
              echo \"\$NEW_COLOR\" > current_color
              echo \"✅ 部署成功！\"
            else
              ./scripts/rollback
              exit 1
            fi
          "