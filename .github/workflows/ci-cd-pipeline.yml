name: Deploy to RHEL VM

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: wkk08/web-calculator-ci-cd
  DEPLOY_DIR: /opt/web-calculator-ci-cd

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run unit tests
      run: |
        python -m pytest tests/unit/ -v

  build:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up SSH environment
      run: |
        echo "=== 设置 SSH 环境 ==="
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # 正确写入私钥 - 使用带EOF的heredoc格式确保保留换行符
        cat << 'EOF' > ~/.ssh/deploy_key
        ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
        EOF
        
        # 或者使用更简单的方式
        # echo "${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        
        chmod 600 ~/.ssh/deploy_key
        
        # 添加主机到known_hosts
        ssh-keyscan -H ${{ secrets.DEPLOY_SERVER_IP }} >> ~/.ssh/known_hosts 2>/dev/null
        
        echo "私钥文件大小:"
        wc -l ~/.ssh/deploy_key
        echo "私钥文件权限:"
        ls -la ~/.ssh/deploy_key
        echo "=== SSH 环境设置完成 ==="
    
    - name: Test SSH connection
      run: |
        echo "测试SSH连接..."
        ssh -i ~/.ssh/deploy_key \
            -o BatchMode=yes \
            -o ConnectTimeout=5 \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER_IP }} "echo 'SSH连接成功!'"
    
    - name: Copy files to RHEL VM
      run: |
        echo "开始复制文件到RHEL VM..."
        
        # 使用rsync同步文件
        rsync -avz -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          --exclude='.git' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          ./ \
          ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER_IP }}:${{ env.DEPLOY_DIR }}/
    
    - name: Deploy application on RHEL VM
      run: |
        echo "在RHEL VM上部署应用..."
        ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER_IP }} "
          cd ${{ env.DEPLOY_DIR }}
          
          # 给脚本添加执行权限
          chmod +x deploy/scripts/*.sh 2>/dev/null || true
          
          # 如果有自定义部署脚本则使用，否则使用docker-compose
          if [ -f deploy/scripts/deploy.sh ]; then
            echo '使用自定义部署脚本'
            ./deploy/scripts/deploy.sh
          else
            echo '使用docker-compose部署'
            docker-compose down || docker compose down
            docker-compose up -d --build || docker compose up -d --build
          fi
          
          echo '等待应用启动...'
          sleep 10
          
          # 检查容器状态
          docker ps
        "
    
    - name: Verify deployment
      run: |
        echo "验证部署..."
        ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER_IP }} "
          # 检查应用是否在运行
          if curl -s http://localhost:5000 > /dev/null; then
            echo '应用运行正常'
          else
            echo '应用可能未启动，检查日志:'
            docker logs web-calculator-app 2>/dev/null || echo '容器日志不可用'
            exit 1
          fi
        "
    
    - name: Clean up SSH key
      run: |
        echo "清理SSH密钥..."
        rm -f ~/.ssh/deploy_key