name: Debug SSH Connection

on:
  workflow_dispatch:  # 手动触发

jobs:
  debug-ssh:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # 写入私钥 - 使用heredoc确保格式正确
        cat << 'EOF' > ~/.ssh/deploy_key
        ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
        EOF
        
        chmod 600 ~/.ssh/deploy_key
        
        # 添加主机到known_hosts
        ssh-keyscan -H ${{ secrets.DEPLOY_SERVER_IP }} >> ~/.ssh/known_hosts 2>/dev/null
        
        echo "SSH配置完成"
    
    - name: Run SSH debug commands
      run: |
        echo "=== 运行SSH调试命令 ==="
        echo ""
        
        # 1. 检查SSH版本
        echo "SSH客户端版本:"
        ssh -V
        
        echo ""
        # 2. 测试不同详细级别
        echo "测试不同详细级别:"
        for level in 1 2 3; do
          echo "=== 详细级别 -v x$level ==="
          ssh -$(printf 'v%.0s' $(seq 1 $level)) \
              -i ~/.ssh/deploy_key \
              -o ConnectTimeout=3 \
              ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER_IP }} \
              "echo '级别$level成功'" || echo "级别$level失败"
          echo ""
        done
        
        echo ""
        # 3. 检查支持的认证方法
        echo "检查支持的认证方法:"
        ssh -v -i ~/.ssh/deploy_key \
            -o PreferredAuthentications=publickey \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER_IP }} 2>&1 | \
            grep -i "authenticat"
    
    - name: Capture full debug output
      run: |
        echo "=== 捕获完整调试输出 ==="
        # 将完整输出保存到文件
        ssh -vvv -i ~/.ssh/deploy_key \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER_IP }} \
            "echo '完整调试测试'" 2>&1 | tee ssh_full_debug.log
        
        echo ""
        echo "=== 分析输出 ==="
        echo "1. 认证相关行:"
        grep -i "authenticat\|auth\|key" ssh_full_debug.log || true
        
        echo ""
        echo "2. 错误相关行:"
        grep -i "error\|fail\|denied\|refused" ssh_full_debug.log || true
        
        echo ""
        echo "3. 成功相关行:"
        grep -i "success\|connected\|established" ssh_full_debug.log || true