echo '=== 部署环境初始化 ==='
echo ''

# 检查 Podman
if command -v podman &> /dev/null; then
    echo '✅ Podman 已安装:'
    podman --version
else
    echo '❌ Podman 未安装'
    echo '请安装 Podman: https://podman.io/docs/installation'
    exit 1
fi

# 检查 Podman Compose
if command -v podman-compose &> /dev/null; then
    echo '✅ Podman Compose 已安装:'
    podman-compose --version
else
    echo '⚠️  Podman Compose 未安装，尝试安装...'
    if command -v pip3 &> /dev/null; then
        pip3 install podman-compose
    elif command -v pip &> /dev/null; then
        pip install podman-compose
    else
        echo '❌ 未找到 pip，无法安装 podman-compose'
        echo '可以手动安装: curl -o /usr/local/bin/podman-compose https://raw.githubusercontent.com/containers/podman-compose/devel/podman_compose.py'
        echo '然后执行: chmod +x /usr/local/bin/podman-compose'
    fi
fi

# 检查其他工具
echo ''
echo '=== 检查必要工具 ==='
for tool in curl git; do
    if command -v  &> /dev/null; then
        echo ✅ 已安装
    else
        echo ⚠️ 未安装，尝试安装...
        # 尝试使用本地 RPM 包或跳过
        echo 如果无法安装，请手动安装 
    fi
done

# 设置 Docker 别名（指向 Podman）
echo ''
echo '=== 配置环境 ==='
if ! grep -q alias docker= ~/.bashrc 2>/dev/null; then
    echo 'alias docker=podman' >> ~/.bashrc
    echo '✅ 已将 docker 命令设置为 podman 别名'
else
    echo '✅ docker 别名已设置'
fi

if command -v podman-compose &> /dev/null && ! grep -q alias docker-compose= ~/.bashrc 2>/dev/null; then
    echo 'alias docker-compose=podman-compose' >> ~/.bashrc
    echo '✅ 已将 docker-compose 命令设置为 podman-compose 别名'
fi

# 刷新 bashrc
source ~/.bashrc 2>/dev/null || true

echo ''
echo '=== 验证配置 ==='
echo '运行以下命令测试:'
echo '1. docker --version'
echo '2. docker run hello-world'
echo '3. 检查当前目录: ls -la'
echo ''
echo '✅ 初始化完成！'
echo '下一步: 运行部署脚本测试'
